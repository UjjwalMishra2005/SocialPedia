{% extends 'base.html' %}
{% load static %}
{% block content %}
    <style>

      .send-button {
        display: flex;
        align-items: center;
        background-color: #55c3d1;
        color: white;
        border: none;
        border-radius: 50px;
        padding: 10px 25px;
        font-size: 15px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        outline: none;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        position: relative;
        
        left:460px;
      }
      
      .send-button:hover {
        background-color: #48aeb8;
        transform: translateY(-2px);
      }
      
      .send-button:active {
        transform: translateY(0);
      }
      
      .send-button .icon {
        font-size: 20px;
        margin-right: 10px;
      }
    </style>

    <main class="profile-page layout layout--2">
      <div class="container">
        <!-- Room Start -->
        <div class="room">
          <div class="room__top">
            <div class="room__topLeft">
              <a href="{% url 'home' %}">
                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                  <title>arrow-left</title>
                  <path
                    d="M13.723 2.286l-13.723 13.714 13.719 13.714 1.616-1.611-10.96-10.96h27.625v-2.286h-27.625l10.965-10.965-1.616-1.607z"
                  ></path>
                </svg>
              </a>
              <h3>Study Room</h3>
            </div>

            <div class="room__topRight">
              {% if request.user == room.host or request.user.is_superuser %}
              <a href="{% url 'update-room' pk %}">
                <svg
                  enable-background="new 0 0 24 24"
                  height="32"
                  viewBox="0 0 24 24"
                  width="32"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <title>Edit</title>
                  <g>
                    <path d="m23.5 22h-15c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h15c.276 0 .5.224.5.5s-.224.5-.5.5z" />
                  </g>
                  <g>
                    <g>
                      <path
                        d="m2.5 22c-.131 0-.259-.052-.354-.146-.123-.123-.173-.3-.133-.468l1.09-4.625c.021-.09.067-.173.133-.239l14.143-14.143c.565-.566 1.554-.566 2.121 0l2.121 2.121c.283.283.439.66.439 1.061s-.156.778-.439 1.061l-14.142 14.141c-.065.066-.148.112-.239.133l-4.625 1.09c-.038.01-.077.014-.115.014zm1.544-4.873-.872 3.7 3.7-.872 14.042-14.041c.095-.095.146-.22.146-.354 0-.133-.052-.259-.146-.354l-2.121-2.121c-.19-.189-.518-.189-.707 0zm3.081 3.283h.01z"
                      />
                    </g>
                    <g>
                      <path
                        d="m17.889 10.146c-.128 0-.256-.049-.354-.146l-3.535-3.536c-.195-.195-.195-.512 0-.707s.512-.195.707 0l3.536 3.536c.195.195.195.512 0 .707-.098.098-.226.146-.354.146z"
                      />
                    </g>
                  </g>
                </svg>
              </a>
              <a href="{% url 'deleteroom' room.id %}">
                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                  <title>Remove</title>
                  <path
                    d="M27.314 6.019l-1.333-1.333-9.98 9.981-9.981-9.981-1.333 1.333 9.981 9.981-9.981 9.98 1.333 1.333 9.981-9.98 9.98 9.98 1.333-1.333-9.98-9.98 9.98-9.981z"
                  ></path>
                </svg>
              </a>
              {% endif %}
            </div>

            <!-- <button class="action-button" data-id="120" data-delete-url="https://randomuser.me/api/3324923"
            data-edit-url="profile.html">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
              <title>ellipsis-horizontal</title>
              <path
                d="M16 7.843c-2.156 0-3.908-1.753-3.908-3.908s1.753-3.908 3.908-3.908c2.156 0 3.908 1.753 3.908 3.908s-1.753 3.908-3.908 3.908zM16 1.98c-1.077 0-1.954 0.877-1.954 1.954s0.877 1.954 1.954 1.954c1.077 0 1.954-0.877 1.954-1.954s-0.877-1.954-1.954-1.954z">
              </path>
              <path
                d="M16 19.908c-2.156 0-3.908-1.753-3.908-3.908s1.753-3.908 3.908-3.908c2.156 0 3.908 1.753 3.908 3.908s-1.753 3.908-3.908 3.908zM16 14.046c-1.077 0-1.954 0.877-1.954 1.954s0.877 1.954 1.954 1.954c1.077 0 1.954-0.877 1.954-1.954s-0.877-1.954-1.954-1.954z">
              </path>
              <path
                d="M16 31.974c-2.156 0-3.908-1.753-3.908-3.908s1.753-3.908 3.908-3.908c2.156 0 3.908 1.753 3.908 3.908s-1.753 3.908-3.908 3.908zM16 26.111c-1.077 0-1.954 0.877-1.954 1.954s0.877 1.954 1.954 1.954c1.077 0 1.954-0.877 1.954-1.954s-0.877-1.954-1.954-1.954z">
              </path>
            </svg>
          </button> -->
          </div>
          <div class="room__box scroll">
            <div class="room__header scroll">
              <div class="room__info">
                <h3>{{room.name}}</h3>
                <span>{{room.created|timesince}} ago</span>
              </div>
              <div class="room__hosted">
                <p>Hosted By</p>
                <a href="{% url 'Profile' room.host.id %}" class="room__author">
                  <div class="avatar avatar--small">
                    <img src="https://randomuser.me/api/portraits/men/37.jpg" />
                  </div>
                  <span>@{{room.host.username}}</span>
                </a>
              </div>
              <div class="room__details">
                {% if room.description %}
                {{room.description}}
                {% else %}
                Lorem ipsum dolor sit, amet consectetur adipisicing elit. Quasi, tenetur laudantium? Dicta repellendus
                rerum consectetur, voluptatem repudiandae eum ea porro cupiditate provident nulla, deserunt, ab ipsum
                corporis laboriosam deleniti molestias?
                {% endif %}
              </div>
              <span class="room__topics">{{room.topic.name}}</span>
            </div>
            <div class="room__conversation">
              <div class="threads scroll" id ="thread__container">
                {% for message in room_messages %}
                <div class="thread">
                  <div class="thread__top">
                    <div class="thread__author">
                      <a href="{% url 'Profile' message.user.id %}" class="thread__authorInfo">
                        <div class="avatar avatar--small">
                          <img src="https://randomuser.me/api/portraits/men/37.jpg" />
                        </div>
                        <span>@{{message.user.username}}</span>
                      </a>
                      <span class="thread__date">{{message.created|timesince}} ago</span>
                    </div>
                    {% if request.user == message.user or request.user.is_superuser %}
                    <div class="thread__delete">
                    
                      <a href="{% url 'delete_message' pk1=room.id pk2=message.id  %}">
                        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                          <title>Remove</title>
                          <path
                            d="M27.314 6.019l-1.333-1.333-9.98 9.981-9.981-9.981-1.333 1.333 9.981 9.981-9.981 9.98 1.333 1.333 9.981-9.98 9.98 9.98 1.333-1.333-9.98-9.98 9.98-9.981z"
                          ></path>
                        </svg>
                      </a>
                      
                    </div>
                    {% endif %}
                  </div>
                  <div class="thread__details">
                    {{message}}
                  </div>
                </div>
                {% endfor %}

                <div class="thread">
                  <div class="thread__top">
                    <div class="thread__author">
                      <a href="#" class="thread__authorInfo">
                        <div class="avatar avatar--small">
                          <img src="https://randomuser.me/api/portraits/men/37.jpg" />
                        </div>
                        <span>@dennis_ivy</span>
                      </a>
                      <span class="thread__date">3 day ago</span>
                    </div>
                    <div class="thread__delete">
                      <a href="#">
                        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                          <title>remove</title>
                          <path
                            d="M27.314 6.019l-1.333-1.333-9.98 9.981-9.981-9.981-1.333 1.333 9.981 9.981-9.981 9.98 1.333 1.333 9.981-9.98 9.98 9.98 1.333-1.333-9.98-9.98 9.98-9.981z"
                          ></path>
                        </svg>
                      </a>
                    </div>
                  </div>
                  <div class="thread__details">
                    Lorem ipsum dolor sit amet consectetur adipisicing elit. Atque nobis, deserunt cum quibusdam aliquam
                    nihil unde et impedit, sequi, modi quos porro iure enim suscipit itaque earum tenetur praesentium
                    quaerat! Corporis praesentium aspernatur autem laboriosam natus similique, adipisci nam maxime.
                  </div>
                </div>

              </div>
            </div>
          </div>
          <div class="room__message">
            <form id="form" action="{% url 'rooms' room.id %}" method="POST" >
              {% csrf_token %}
              <input  class="message-input-box" name="body" placeholder="Write your message here..." />
              <!-- <button class="send-button">
                <span class="icon">âž¤</span> Send
              </button> -->
            </form>
          </div>
        </div>
        <!-- Room End -->
        

        <!-- Participant list Start -->
        <div class="participants">
          <h3 class="participants__top">Participants <span>(5.3k Joined)</span></h3>
          <div class="participants__list scroll">
            
          </div>
        </div>
        <!--  End -->
      </div>
    </main>
    <script>
      let url = `ws://${window.location.host}/ws/socket-server/`
      const baseSocket = new WebSocket(url)
      baseSocket.onmessage = function(e){
        let data = JSON.parse(e.data)
        console.log('Data:',data)
        if (data.type === "message"){
          console.log("user.id === ",`${data.id}`)
          
          
            // Create main thread container
            const thread = document.createElement("div");
            thread.classList.add("thread");
          
            // Create thread__top
            const threadTop = document.createElement("div");
            threadTop.classList.add("thread__top");
          
            // Create thread__author
            const threadAuthor = document.createElement("div");
            threadAuthor.classList.add("thread__author");
          
            const authorLink = document.createElement("a");
            authorLink.classList.add("thread__authorInfo");
            authorLink.setAttribute("href", `/Profile/${data.id}`); // Replace with actual URL
          
          
            const avatar = document.createElement("div");
            avatar.classList.add("avatar", "avatar--small");
          
            const img = document.createElement("img");
            img.setAttribute("src", "https://randomuser.me/api/portraits/men/37.jpg"); // Replace if needed
          
            avatar.appendChild(img);
          
            const username = document.createElement("span");
            username.textContent = "@{{request.user.username}}"; // Replace with actual username
          
            authorLink.appendChild(avatar);
            authorLink.appendChild(username);
          
            const dateSpan = document.createElement("span");
            dateSpan.classList.add("thread__date");
            dateSpan.textContent = "just now"; // Replace with actual time
          
            threadAuthor.appendChild(authorLink);
            threadAuthor.appendChild(dateSpan);
          
            // Create thread__delete (optional â€” include only if conditions are met)
            const threadDelete = document.createElement("div");
            threadDelete.classList.add("thread__delete");
          
            const deleteLink = document.createElement("a");
            deleteLink.setAttribute("href", '#'); // Replace with actual delete URL
          
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", "32");
            svg.setAttribute("height", "32");
            svg.setAttribute("viewBox", "0 0 32 32");
          
            const title = document.createElementNS("http://www.w3.org/2000/svg", "title");
            title.textContent = "Remove";
          
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", "M27.314 6.019l-1.333-1.333-9.98 9.981-9.981-9.981-1.333 1.333 9.981 9.981-9.981 9.98 1.333 1.333 9.981-9.98 9.98 9.98 1.333-1.333-9.98-9.98 9.98-9.981z");
          
            svg.appendChild(title);
            svg.appendChild(path);
            deleteLink.appendChild(svg);
            threadDelete.appendChild(deleteLink);
          
            // Assemble the thread__top
            threadTop.appendChild(threadAuthor);
            threadTop.appendChild(threadDelete); // Add this only if the condition is true
            threadDetails = document.createElement('div')
            threadDetails.textContent = `${data.message}`
            threadDetails.classList.add('thread__details')
            thread.appendChild(threadTop);
            thread.appendChild(threadDetails);
            // Add top section to thread
            
          
            // Prepend to thread container
            const threadContainer = document.getElementById("thread__container");
            if (threadContainer) {
              threadContainer.prepend(thread);
            }
            else{
              console.log("not accessed")
            }
          }
          
          
        }
      

      let form = document.getElementById('form')
      form.addEventListener('submit',(e)=>{
        e.preventDefault()
        let message = e.target.body.value
        baseSocket.send(JSON.stringify({
          'message':message,
          'room_id':"{{ room.id }}",
          'user_id':"{{ request.user.id }}"
        }))
        form.reset()
      })
    </script>
    <script src="{% static 'js/script.js' %}"></script>

  {% endblock %}
